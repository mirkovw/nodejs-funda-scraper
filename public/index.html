<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Funda Listings</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <input
      placeholder="Minimal Elevation (m)"
      type="number"
      id="elevation"
      style="position: absolute; top: 10px; left: 10px; z-index: 1"
    />

    <button
      style="position: absolute; top: 10px; right: 10px; z-index: 1"
      id="reset"
    >
      Reset view
    </button>

    <button
      style="position: absolute; top: 40px; right: 10px; z-index: 1"
      id="update"
    >
      Update
    </button>
    <script>
      (async () => {
        document.getElementById("elevation").addEventListener("input", (e) => {
          const elevation = e.target.value;
          const filteredFeatures = fc.features.filter((feature) => {
            return feature.properties.elevation >= elevation;
          });

          map.getSource("earthquakes").setData({
            type: "FeatureCollection",
            features: filteredFeatures,
          });
        });

        document.getElementById("update").addEventListener("click", () => {
          runFullUpdate();
        });

        document.getElementById("reset").addEventListener("click", () => {
          map.flyTo({ center: [5.506484398523903, 52.3953340156272], zoom: 8 });
        });

        function runFullUpdate() {
          fetch("/run-full-update")
            .then((response) => response.text())
            .then((text) => {
              console.log(text);
            });
        }
        const fc = await fetch("listings.json").then((response) =>
          response.json()
        );

        console.log("features loaded", fc.features.length);

        mapboxgl.accessToken =
          "pk.eyJ1IjoibWlya292dyIsImEiOiJjbHoydDlvdnIwMXd6MmxzOTh6ZGRjNDJzIn0.bVUj4FRgi4cBaaDD17Rjzg";
        const map = new mapboxgl.Map({
          container: "map",
          style: "mapbox://styles/mapbox/streets-v11",
          center: [5.506484398523903, 52.3953340156272],
          zoom: 8,
          // testMode: true,
        });

        map.on("load", () => {
          map.addSource("earthquakes", {
            type: "geojson",
            data: fc,
            cluster: true,
            clusterMaxZoom: 14, // Max zoom to cluster points on
            clusterRadius: 35, // Radius of each cluster when clustering points (defaults to 50)
          });

          const tileUrl =
            `https://service.pdok.nl/rws/ahn/wms/v1_0?service=WMS&request=getMap` +
            `&version=1.3.0&layers=dsm_05m&styles=&format=image/png&crs=EPSG:3857&` +
            `bbox={bbox-epsg-3857}&width=256&height=256&transparent=true`;

          map.addSource("ahn-wms-source", {
            type: "raster",
            tiles: [tileUrl],
            tileSize: 256,
          });
          map.addLayer(
            {
              id: "ahn-layer",
              type: "raster",
              source: "ahn-wms-source",
              paint: {},
            },
            "building" // Place layer under labels, roads and buildings.
          );

          map.addLayer({
            id: "clusters",
            type: "circle",
            source: "earthquakes",
            filter: ["has", "point_count"],
            paint: {
              "circle-color": [
                "step",
                ["get", "point_count"],
                "#51bbd6",
                100,
                "#f1f075",
                750,
                "#f28cb1",
              ],
              "circle-radius": [
                "step",
                ["get", "point_count"],
                20,
                100,
                30,
                750,
                40,
              ],
            },
          });

          map.addLayer({
            id: "cluster-count",
            type: "symbol",
            source: "earthquakes",
            filter: ["has", "point_count"],
            layout: {
              "text-field": ["get", "point_count_abbreviated"],
              "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
              "text-size": 12,
            },
          });

          map.addLayer({
            id: "unclustered-point",
            type: "symbol",
            source: "earthquakes",
            filter: ["!", ["has", "point_count"]],
            layout: {
              "text-field": [
                "number-format",
                ["get", "price"],
                {
                  currency: "EUR",
                },
              ],
              "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
              "text-size": 12,
            },
            paint: {
              "text-color": "#000",
              "background-color": "#FF0000",
              "text-halo-color": "#32de84",
              "text-halo-width": 10,
            },
            fill: {
              "fill-color": "#FF0000",
            },
          });

          // inspect a cluster on click
          map.on("click", "clusters", (e) => {
            const features = map.queryRenderedFeatures(e.point, {
              layers: ["clusters"],
            });
            const clusterId = features[0].properties.cluster_id;
            map
              .getSource("earthquakes")
              .getClusterExpansionZoom(clusterId, (err, zoom) => {
                if (err) return;

                map.easeTo({
                  center: features[0].geometry.coordinates,
                  zoom: zoom,
                });
              });
          });

          // When a click event occurs on a feature in
          // the unclustered-point layer, open a popup at
          // the location of the feature, with
          // description HTML from its properties.
          map.on("click", "unclustered-point", (e) => {
            const coordinates = e.features[0].geometry.coordinates.slice();
            // Ensure that if the map is zoomed out such that
            // multiple copies of the feature are visible, the
            // popup appears over the copy being pointed to.
            if (
              ["mercator", "equirectangular"].includes(map.getProjection().name)
            ) {
              while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
              }
            }

            new mapboxgl.Popup()
              .setLngLat(coordinates)
              .setHTML(getListingHtmlFromFeature(e.features[0]))
              .addTo(map);
          });

          map.on("mouseenter", "clusters", () => {
            map.getCanvas().style.cursor = "pointer";
          });
          map.on("mouseleave", "clusters", () => {
            map.getCanvas().style.cursor = "";
          });
        });

        function getListingHtmlFromFeature(feature) {
          var {
            streetName,
            city,
            link,
            price,
            surface,
            land,
            rooms,
            energyLabel,
            elevation,
          } = feature.properties;

          return `
          <div>
            <h3>${streetName}, ${city}</h3>
            <p>Elevation: ${elevation} m</p>
            <p>Energy label: ${energyLabel}</p>
            <p>Price: €${price.toLocaleString()}</p>
            <p>Surface: ${surface} m²</p>
            <p>Land: ${land} m²</p>
            <p>Rooms: ${rooms}</p>
            <a href="${link}" target="_blank">More info</a>
          </div>
        `;
        }
      })();
    </script>
  </body>
</html>
